# Ticket 1.6: c15tInstance Factory

## üìã Ticket Details
**Phase**: 1 - Core Analytics Infrastructure  
**Story Points**: 2  
**Priority**: Critical  
**Assignee**: TBD  
**Status**: Ready

## üîó Dependencies
**Depends on**: All Phase 1 tickets (1.1-1.5)  
**Blocking**: Phase 2 (Universal Destinations)  

## üéØ Description
Build the main factory function for creating analytics instances. This is the primary entry point that developers use to initialize the analytics system with their configuration.

## üß† Context & Background
This factory function is the main API that developers interact with to set up analytics. It must:
- Accept configuration options and validate them
- Initialize all core components (EventProcessor, DestinationManager, etc.)
- Load and register destinations from configuration
- Return a context object with handlers and utilities
- Handle errors gracefully during initialization
- Provide a clean, type-safe API

The factory integrates all the components built in previous tickets:
- DestinationRegistry for managing destination types
- DestinationManager for processing events
- EventProcessor for validation and enrichment
- Analytics handler for HTTP endpoints
- Logger for debugging and monitoring

## ‚úÖ Acceptance Criteria
- [ ] Create `c15tInstance` function
- [ ] Accept `C15TOptions` with analytics config
- [ ] Initialize DestinationManager
- [ ] Load destinations from config
- [ ] Return context with handler
- [ ] Add proper error handling
- [ ] Unit tests for factory
- [ ] Integration tests with full flow

## üìÅ Files to Update
- `packages/backend/src/v2/init.ts` (extend existing init)

## üîß Implementation Details

### Factory Function Implementation
```typescript
import { DestinationRegistry, destinationRegistry } from './analytics/destination-registry';
import { DestinationManager } from './analytics/destination-manager';
import { EventProcessor } from './analytics/event-processor';
import { processEventsHandler } from './handlers/analytics/process.handler';
import { C15TOptions, DestinationConfig } from './analytics/types';
import { Logger } from './logger';

// Context returned by factory
interface C15TContext {
  // Core components
  destinationManager: DestinationManager;
  eventProcessor: EventProcessor;
  logger: Logger;
  
  // HTTP handlers
  handlers: {
    processEvents: typeof processEventsHandler;
  };
  
  // Utilities
  utils: {
    getDestinationStatus: (type: string) => any;
    testDestination: (type: string) => Promise<boolean>;
    getLoadedDestinations: () => any[];
  };
}

// Factory function
export async function c15tInstance(options: C15TOptions = {}): Promise<C15TContext> {
  const logger = new Logger({ component: 'c15t' });
  
  try {
    logger.info('Initializing c15t analytics instance', { options });
    
    // Validate options
    const validatedOptions = validateOptions(options);
    
    // Initialize core components
    const eventProcessor = new EventProcessor(logger);
    const destinationManager = new DestinationManager(destinationRegistry, logger);
    
    // Load destinations if analytics is enabled
    if (validatedOptions.analytics?.enabled !== false) {
      const destinations = validatedOptions.analytics?.destinations || [];
      
      if (destinations.length > 0) {
        logger.info('Loading destinations', { count: destinations.length });
        await destinationManager.loadDestinations(destinations);
      }
    }
    
    // Create context
    const context: C15TContext = {
      destinationManager,
      eventProcessor,
      logger,
      handlers: {
        processEvents: (req, res) => processEventsHandler(req, res, {
          eventProcessor,
          destinationManager,
          logger,
        }),
      },
      utils: {
        getDestinationStatus: (type: string) => destinationManager.getDestinationStatus(type),
        testDestination: (type: string) => destinationManager.testDestination(type),
        getLoadedDestinations: () => destinationManager.getLoadedDestinations(),
      },
    };
    
    logger.info('c15t analytics instance initialized successfully');
    return context;
    
  } catch (error) {
    logger.error('Failed to initialize c15t analytics instance', {
      error: error.message,
      stack: error.stack,
    });
    throw new Error(`Failed to initialize c15t: ${error.message}`);
  }
}

// Options validation
function validateOptions(options: C15TOptions): C15TOptions {
  const validated = { ...options };
  
  // Validate analytics options
  if (validated.analytics) {
    const { destinations = [], loadFromDatabase = false, organizationId, environment } = validated.analytics;
    
    // Validate destinations
    for (const dest of destinations) {
      if (!dest.type) {
        throw new Error('Destination type is required');
      }
      if (!dest.settings) {
        throw new Error('Destination settings are required');
      }
    }
    
    // Validate database loading options
    if (loadFromDatabase && !organizationId) {
      throw new Error('organizationId is required when loadFromDatabase is true');
    }
    
    validated.analytics = {
      ...validated.analytics,
      destinations,
      loadFromDatabase,
      organizationId,
      environment,
    };
  }
  
  return validated;
}

// Helper function to create handler context
function createHandlerContext(context: C15TContext) {
  return {
    eventProcessor: context.eventProcessor,
    destinationManager: context.destinationManager,
    logger: context.logger,
  };
}

// Export types for external use
export type { C15TContext, C15TOptions };
export { destinationRegistry };
```

### Usage Examples
```typescript
// Basic usage
const instance = await c15tInstance({
  analytics: {
    destinations: [
      posthog({ apiKey: 'phc_xxx' }),
      console({ logLevel: 'debug' }),
    ],
  },
});

// With database loading
const instance = await c15tInstance({
  analytics: {
    loadFromDatabase: true,
    organizationId: 'org-123',
    environment: 'production',
  },
});

// Using the handlers
app.post('/analytics/process', instance.handlers.processEvents);

// Using utilities
const status = instance.utils.getDestinationStatus('posthog');
const isConnected = await instance.utils.testDestination('posthog');
const destinations = instance.utils.getLoadedDestinations();
```

### Error Handling
```typescript
// Custom error types for initialization
export class C15TInitializationError extends Error {
  constructor(message: string, public component?: string) {
    super(message);
    this.name = 'C15TInitializationError';
  }
}

export class ConfigurationError extends C15TInitializationError {
  constructor(message: string, public field?: string) {
    super(message, 'configuration');
    this.name = 'ConfigurationError';
  }
}

// Error handling in factory
function handleInitializationError(error: Error, component: string): never {
  if (error instanceof ConfigurationError) {
    throw error;
  }
  
  throw new C15TInitializationError(
    `Failed to initialize ${component}: ${error.message}`,
    component
  );
}
```

## üß™ Testing Requirements
- Unit tests for factory function
- Integration tests with full analytics flow
- Error handling tests
- Configuration validation tests
- Component initialization tests
- Handler creation tests

## üîç Definition of Done
- [ ] Factory function creates analytics instance
- [ ] Options validated and processed
- [ ] DestinationManager initialized
- [ ] Destinations loaded from config
- [ ] Context returned with handler
- [ ] Error handling implemented
- [ ] Unit tests for factory
- [ ] Integration tests with full flow
- [ ] Code review completed

## üìö Related Documentation
- [Analytics Architecture Diagram](../docs/analytics-architecture-diagram.md)
- [Analytics Implementation Roadmap](../docs/analytics-implementation-roadmap.md)

## üîó Dependencies
- [1.1: Core Analytics Types](./01-core-analytics-types.md) ‚úÖ
- [1.2: Destination Registry & Manager](./02-destination-registry-manager.md) ‚úÖ
- [1.3: Event Processor](./03-event-processor.md) ‚úÖ
- [1.4: Core Server Destinations](./04-core-server-destinations.md) ‚úÖ
- [1.5: Analytics Handler & API](./05-analytics-handler-api.md) ‚úÖ

## üöÄ Next Phase
[Phase 2: Universal Destinations](./07-universal-destination-interface.md)

## üéØ Phase 1 Complete
Once this ticket is done, Phase 1 is complete! You should have:
- ‚úÖ Working analytics system with PostHog + Console destinations
- ‚úÖ All tests passing (90%+ coverage)
- ‚úÖ Basic analytics flow working end-to-end
- ‚úÖ Performance within 10% of event-sidekick
