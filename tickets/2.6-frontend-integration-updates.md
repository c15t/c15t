# Ticket 5.7: Implement Frontend Integration Updates

## 📋 Ticket Details
**Phase**: 5 - Advanced Features  
**Estimate**: 2 days  
**Priority**: High  
**Assignee**: TBD  
**Status**: Ready  

## 🎯 Description
Update the existing frontend integration components to work with the new analytics system. This includes updating `ConsentManagerProvider`, `useAnalyticsScripts` hook, and other React components to integrate with the new event queue, script management, and consent synchronization systems.

## 🧠 Context & Background
The frontend integration needs to be updated to work with the new analytics system:
- **ConsentManagerProvider updates** - Integrate with new consent state management
- **useAnalyticsScripts updates** - Use new script management system
- **Event queue integration** - Connect frontend events to the queue system
- **Consent banner updates** - Work with new consent synchronization
- **Script loading updates** - Use new dynamic script loading
- **Error handling updates** - Integrate with new error handling system

The updates must:
- Maintain backward compatibility where possible
- Integrate with the new event queue system
- Use the new script management hooks
- Work with consent state synchronization
- Handle errors gracefully
- Provide migration path for existing users

## ✅ Acceptance Criteria
- [ ] Update `ConsentManagerProvider` to use new consent sync
- [ ] Update `useAnalyticsScripts` to use new script management
- [ ] Integrate event queue with frontend components
- [ ] Update consent banner to work with new system
- [ ] Add error handling integration
- [ ] Maintain backward compatibility
- [ ] Unit tests for updated components
- [ ] Integration tests with new analytics system

## 📁 Files to Update
- `packages/react/src/components/consent-manager-provider.tsx`
- `packages/react/src/hooks/use-analytics-scripts.ts`
- `packages/react/src/components/consent-banner.tsx`
- `packages/react/src/components/analytics-provider.tsx`

## 🔧 Implementation Details

### Updated ConsentManagerProvider
```typescript
import React, { createContext, useContext, useEffect, useRef } from 'react';
import { AnalyticsConsent } from '@c15t/core';
import { useConsentSync } from '../hooks/use-consent-sync';
import { useScriptManager } from '../hooks/use-script-manager';
import { EventQueue } from '@c15t/core';

export interface ConsentManagerContextType {
  consent: AnalyticsConsent;
  updateConsent: (consent: AnalyticsConsent, source?: string, reason?: string) => Promise<void>;
  resetConsent: () => Promise<void>;
  loading: boolean;
  error?: string;
  lastUpdated: number;
  source: string;
  tabId: string;
  changeHistory: ConsentChangeEvent[];
  consentStats: any;
}

export interface ConsentManagerProviderProps {
  children: React.ReactNode;
  initialConsent?: AnalyticsConsent;
  onConsentChange?: (change: ConsentChangeEvent) => void;
  enableAnalyticsIntegration?: boolean;
  enableScriptManagement?: boolean;
  enableCrossTabSync?: boolean;
  conflictResolution?: 'latest' | 'user-choice' | 'merge';
  scriptManagerOptions?: ScriptManagerOptions;
  eventQueue?: EventQueue;
}

const ConsentManagerContext = createContext<ConsentManagerContextType | null>(null);

export function ConsentManagerProvider({
  children,
  initialConsent,
  onConsentChange,
  enableAnalyticsIntegration = true,
  enableScriptManagement = true,
  enableCrossTabSync = true,
  conflictResolution = 'latest',
  scriptManagerOptions = {},
  eventQueue,
}: ConsentManagerProviderProps) {
  // Use new consent sync hook
  const consentSync = useConsentSync({
    enableCrossTabSync,
    conflictResolution,
    onConsentChange,
  });

  // Use new script manager hook
  const scriptManager = useScriptManager({
    enableCrossTabSync,
    ...scriptManagerOptions,
  });

  // Event queue integration
  const eventQueueRef = useRef<EventQueue>();
  
  useEffect(() => {
    if (eventQueue) {
      eventQueueRef.current = eventQueue;
    }
  }, [eventQueue]);

  // Handle consent changes
  useEffect(() => {
    if (enableAnalyticsIntegration && eventQueueRef.current) {
      // Update event queue when consent changes
      eventQueueRef.current.updateConsent(consentSync.consent);
    }

    if (enableScriptManagement) {
      // Update scripts when consent changes
      scriptManager.loadScripts(consentSync.consent);
    }
  }, [consentSync.consent, enableAnalyticsIntegration, enableScriptManagement]);

  // Set initial consent if provided
  useEffect(() => {
    if (initialConsent && !consentSync.loading) {
      consentSync.updateConsent(initialConsent, 'initialization');
    }
  }, [initialConsent, consentSync.loading]);

  // Handle consent change events
  const handleConsentChange = async (
    newConsent: AnalyticsConsent,
    source: string = 'user-action',
    reason?: string
  ) => {
    try {
      await consentSync.updateConsent(newConsent, source, reason);
      
      // Update scripts if enabled
      if (enableScriptManagement) {
        await scriptManager.loadScripts(newConsent);
      }
      
      // Update event queue if enabled
      if (enableAnalyticsIntegration && eventQueueRef.current) {
        await eventQueueRef.current.updateConsent(newConsent);
      }
      
    } catch (error) {
      console.error('Failed to update consent', error);
    }
  };

  // Handle consent reset
  const handleResetConsent = async () => {
    try {
      await consentSync.resetConsent();
      
      // Reset scripts if enabled
      if (enableScriptManagement) {
        await scriptManager.clearCache();
      }
      
    } catch (error) {
      console.error('Failed to reset consent', error);
    }
  };

  const contextValue: ConsentManagerContextType = {
    consent: consentSync.consent,
    updateConsent: handleConsentChange,
    resetConsent: handleResetConsent,
    loading: consentSync.loading,
    error: consentSync.error,
    lastUpdated: consentSync.lastUpdated,
    source: consentSync.source,
    tabId: consentSync.tabId,
    changeHistory: consentSync.getChangeHistory(),
    consentStats: consentSync.getConsentStats(),
  };

  return (
    <ConsentManagerContext.Provider value={contextValue}>
      {children}
    </ConsentManagerContext.Provider>
  );
}

export function useConsentManager(): ConsentManagerContextType {
  const context = useContext(ConsentManagerContext);
  if (!context) {
    throw new Error('useConsentManager must be used within a ConsentManagerProvider');
  }
  return context;
}
```

### Updated useAnalyticsScripts Hook
```typescript
import { useCallback, useEffect, useRef } from 'react';
import { AnalyticsConsent } from '@c15t/core';
import { useScriptManager, ScriptManagerOptions } from './use-script-manager';
import { useConsentSync } from './use-consent-sync';

export interface UseAnalyticsScriptsOptions extends ScriptManagerOptions {
  enableConsentSync?: boolean;
  enableAutoLoading?: boolean;
  enableErrorHandling?: boolean;
  onScriptLoad?: (script: LoadedScript) => void;
  onScriptError?: (error: ScriptError) => void;
}

export interface UseAnalyticsScriptsReturn {
  scripts: Map<string, LoadedScript>;
  loading: boolean;
  error?: string;
  consent: AnalyticsConsent;
  stats: ScriptManagerStats;
  loadScripts: (consent: AnalyticsConsent) => Promise<void>;
  unloadScripts: (consent: AnalyticsConsent) => Promise<void>;
  reloadScripts: () => Promise<void>;
  preloadScripts: (consent: AnalyticsConsent) => Promise<void>;
  clearCache: () => void;
  retryFailedScripts: () => Promise<void>;
  getScriptStatus: (scriptId: string) => LoadedScript | null;
  updateConsent: (consent: AnalyticsConsent, source?: string, reason?: string) => Promise<void>;
}

export function useAnalyticsScripts(
  options: UseAnalyticsScriptsOptions = {}
): UseAnalyticsScriptsReturn {
  const {
    enableConsentSync = true,
    enableAutoLoading = true,
    enableErrorHandling = true,
    onScriptLoad,
    onScriptError,
    ...scriptManagerOptions
  } = options;

  // Use script manager hook
  const scriptManager = useScriptManager({
    ...scriptManagerOptions,
    onScriptLoad,
    onScriptError,
  });

  // Use consent sync hook if enabled
  const consentSync = useConsentSync({
    enableCrossTabSync: enableConsentSync,
    onConsentChange: (change) => {
      if (enableAutoLoading) {
        scriptManager.loadScripts(change.newConsent);
      }
    },
  });

  // Handle script loading errors
  useEffect(() => {
    if (enableErrorHandling && scriptManager.error) {
      console.error('Analytics script error', scriptManager.error);
      
      // Retry failed scripts after a delay
      setTimeout(() => {
        scriptManager.retryFailedScripts();
      }, 5000);
    }
  }, [scriptManager.error, enableErrorHandling]);

  // Auto-load scripts when consent changes
  useEffect(() => {
    if (enableAutoLoading && !scriptManager.loading) {
      scriptManager.loadScripts(consentSync.consent);
    }
  }, [consentSync.consent, enableAutoLoading, scriptManager.loading]);

  // Handle consent updates
  const handleUpdateConsent = useCallback(async (
    newConsent: AnalyticsConsent,
    source: string = 'user-action',
    reason?: string
  ) => {
    try {
      await consentSync.updateConsent(newConsent, source, reason);
      
      if (enableAutoLoading) {
        await scriptManager.loadScripts(newConsent);
      }
      
    } catch (error) {
      console.error('Failed to update consent', error);
    }
  }, [consentSync, enableAutoLoading]);

  return {
    ...scriptManager,
    consent: consentSync.consent,
    updateConsent: handleUpdateConsent,
  };
}
```

### Updated Consent Banner Component
```typescript
import React, { useState, useCallback } from 'react';
import { AnalyticsConsent } from '@c15t/core';
import { useConsentManager } from './consent-manager-provider';

export interface ConsentBannerProps {
  onAccept?: (consent: AnalyticsConsent) => void;
  onReject?: (consent: AnalyticsConsent) => void;
  onCustomize?: (consent: AnalyticsConsent) => void;
  showCustomizeButton?: boolean;
  theme?: 'light' | 'dark';
  position?: 'top' | 'bottom';
  enableAnalyticsIntegration?: boolean;
  enableScriptManagement?: boolean;
}

export function ConsentBanner({
  onAccept,
  onReject,
  onCustomize,
  showCustomizeButton = true,
  theme = 'light',
  position = 'bottom',
  enableAnalyticsIntegration = true,
  enableScriptManagement = true,
}: ConsentBannerProps) {
  const [isCustomizing, setIsCustomizing] = useState(false);
  const [customConsent, setCustomConsent] = useState<AnalyticsConsent>({
    necessary: true,
    measurement: false,
    marketing: false,
    functionality: false,
    experience: false,
  });

  const { consent, updateConsent, loading, error } = useConsentManager();

  // Handle accept all
  const handleAcceptAll = useCallback(async () => {
    const allConsent: AnalyticsConsent = {
      necessary: true,
      measurement: true,
      marketing: true,
      functionality: true,
      experience: true,
    };

    try {
      await updateConsent(allConsent, 'banner-accept-all');
      onAccept?.(allConsent);
    } catch (error) {
      console.error('Failed to accept all consent', error);
    }
  }, [updateConsent, onAccept]);

  // Handle reject all
  const handleRejectAll = useCallback(async () => {
    const minimalConsent: AnalyticsConsent = {
      necessary: true,
      measurement: false,
      marketing: false,
      functionality: false,
      experience: false,
    };

    try {
      await updateConsent(minimalConsent, 'banner-reject-all');
      onReject?.(minimalConsent);
    } catch (error) {
      console.error('Failed to reject all consent', error);
    }
  }, [updateConsent, onReject]);

  // Handle customize
  const handleCustomize = useCallback(() => {
    setIsCustomizing(true);
    setCustomConsent(consent);
  }, [consent]);

  // Handle custom consent save
  const handleSaveCustom = useCallback(async () => {
    try {
      await updateConsent(customConsent, 'banner-customize');
      onCustomize?.(customConsent);
      setIsCustomizing(false);
    } catch (error) {
      console.error('Failed to save custom consent', error);
    }
  }, [customConsent, updateConsent, onCustomize]);

  // Handle custom consent cancel
  const handleCancelCustom = useCallback(() => {
    setIsCustomizing(false);
    setCustomConsent(consent);
  }, [consent]);

  // Handle individual consent toggle
  const handleToggleConsent = useCallback((purpose: keyof AnalyticsConsent) => {
    setCustomConsent(prev => ({
      ...prev,
      [purpose]: !prev[purpose],
    }));
  }, []);

  if (loading) {
    return (
      <div className={`consent-banner consent-banner--${theme} consent-banner--${position}`}>
        <div className="consent-banner__content">
          <p>Loading consent preferences...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className={`consent-banner consent-banner--${theme} consent-banner--${position}`}>
        <div className="consent-banner__content">
          <p>Error loading consent preferences: {error}</p>
          <button onClick={() => window.location.reload()}>
            Reload Page
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className={`consent-banner consent-banner--${theme} consent-banner--${position}`}>
      <div className="consent-banner__content">
        {!isCustomizing ? (
          <>
            <h3>Cookie Consent</h3>
            <p>
              We use cookies to enhance your experience and analyze our traffic. 
              Please choose your preferences.
            </p>
            
            <div className="consent-banner__actions">
              <button 
                className="consent-banner__button consent-banner__button--accept"
                onClick={handleAcceptAll}
                disabled={loading}
              >
                Accept All
              </button>
              
              <button 
                className="consent-banner__button consent-banner__button--reject"
                onClick={handleRejectAll}
                disabled={loading}
              >
                Reject All
              </button>
              
              {showCustomizeButton && (
                <button 
                  className="consent-banner__button consent-banner__button--customize"
                  onClick={handleCustomize}
                  disabled={loading}
                >
                  Customize
                </button>
              )}
            </div>
          </>
        ) : (
          <>
            <h3>Customize Cookie Preferences</h3>
            
            <div className="consent-banner__customize">
              <div className="consent-banner__option">
                <label>
                  <input
                    type="checkbox"
                    checked={customConsent.necessary}
                    disabled
                  />
                  <span>Necessary Cookies (Required)</span>
                </label>
                <p>Essential cookies for website functionality.</p>
              </div>
              
              <div className="consent-banner__option">
                <label>
                  <input
                    type="checkbox"
                    checked={customConsent.measurement}
                    onChange={() => handleToggleConsent('measurement')}
                  />
                  <span>Analytics Cookies</span>
                </label>
                <p>Help us understand how visitors interact with our website.</p>
              </div>
              
              <div className="consent-banner__option">
                <label>
                  <input
                    type="checkbox"
                    checked={customConsent.marketing}
                    onChange={() => handleToggleConsent('marketing')}
                  />
                  <span>Marketing Cookies</span>
                </label>
                <p>Used to track visitors across websites for advertising purposes.</p>
              </div>
              
              <div className="consent-banner__option">
                <label>
                  <input
                    type="checkbox"
                    checked={customConsent.functionality}
                    onChange={() => handleToggleConsent('functionality')}
                  />
                  <span>Functionality Cookies</span>
                </label>
                <p>Enable enhanced functionality and personalization.</p>
              </div>
              
              <div className="consent-banner__option">
                <label>
                  <input
                    type="checkbox"
                    checked={customConsent.experience}
                    onChange={() => handleToggleConsent('experience')}
                  />
                  <span>Experience Cookies</span>
                </label>
                <p>Provide personalized content and experiences.</p>
              </div>
            </div>
            
            <div className="consent-banner__actions">
              <button 
                className="consent-banner__button consent-banner__button--save"
                onClick={handleSaveCustom}
                disabled={loading}
              >
                Save Preferences
              </button>
              
              <button 
                className="consent-banner__button consent-banner__button--cancel"
                onClick={handleCancelCustom}
                disabled={loading}
              >
                Cancel
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}
```

### Updated Analytics Provider
```typescript
import React, { createContext, useContext, useEffect, useRef } from 'react';
import { AnalyticsConsent } from '@c15t/core';
import { EventQueue } from '@c15t/core';
import { useConsentManager } from './consent-manager-provider';
import { useAnalyticsScripts } from './use-analytics-scripts';

export interface AnalyticsContextType {
  eventQueue: EventQueue;
  consent: AnalyticsConsent;
  scripts: Map<string, LoadedScript>;
  loading: boolean;
  error?: string;
  track: (event: string, properties?: any) => Promise<void>;
  page: (name: string, properties?: any) => Promise<void>;
  identify: (userId: string, traits?: any) => Promise<void>;
  group: (groupId: string, traits?: any) => Promise<void>;
  alias: (userId: string, previousId?: string) => Promise<void>;
  consent: (consent: AnalyticsConsent) => Promise<void>;
}

export interface AnalyticsProviderProps {
  children: React.ReactNode;
  eventQueue: EventQueue;
  enableScriptManagement?: boolean;
  enableConsentSync?: boolean;
  scriptManagerOptions?: ScriptManagerOptions;
}

const AnalyticsContext = createContext<AnalyticsContextType | null>(null);

export function AnalyticsProvider({
  children,
  eventQueue,
  enableScriptManagement = true,
  enableConsentSync = true,
  scriptManagerOptions = {},
}: AnalyticsProviderProps) {
  const { consent, updateConsent } = useConsentManager();
  
  const analyticsScripts = useAnalyticsScripts({
    enableConsentSync,
    enableAutoLoading: enableScriptManagement,
    ...scriptManagerOptions,
  });

  // Track event
  const track = useCallback(async (event: string, properties?: any) => {
    try {
      await eventQueue.queueEvent({
        type: 'track',
        event,
        properties: properties || {},
        timestamp: Date.now(),
      }, {
        sessionId: getSessionId(),
        userId: getUserId(),
        userAgent: navigator.userAgent,
        ip: await getClientIP(),
        referrer: document.referrer,
        custom: {},
      });
    } catch (error) {
      console.error('Failed to track event', error);
    }
  }, [eventQueue]);

  // Page event
  const page = useCallback(async (name: string, properties?: any) => {
    try {
      await eventQueue.queueEvent({
        type: 'page',
        name,
        properties: properties || {},
        timestamp: Date.now(),
      }, {
        sessionId: getSessionId(),
        userId: getUserId(),
        userAgent: navigator.userAgent,
        ip: await getClientIP(),
        referrer: document.referrer,
        custom: {},
      });
    } catch (error) {
      console.error('Failed to track page', error);
    }
  }, [eventQueue]);

  // Identify user
  const identify = useCallback(async (userId: string, traits?: any) => {
    try {
      await eventQueue.queueEvent({
        type: 'identify',
        userId,
        traits: traits || {},
        timestamp: Date.now(),
      }, {
        sessionId: getSessionId(),
        userId,
        userAgent: navigator.userAgent,
        ip: await getClientIP(),
        referrer: document.referrer,
        custom: {},
      });
    } catch (error) {
      console.error('Failed to identify user', error);
    }
  }, [eventQueue]);

  // Group user
  const group = useCallback(async (groupId: string, traits?: any) => {
    try {
      await eventQueue.queueEvent({
        type: 'group',
        groupId,
        traits: traits || {},
        timestamp: Date.now(),
      }, {
        sessionId: getSessionId(),
        userId: getUserId(),
        userAgent: navigator.userAgent,
        ip: await getClientIP(),
        referrer: document.referrer,
        custom: {},
      });
    } catch (error) {
      console.error('Failed to group user', error);
    }
  }, [eventQueue]);

  // Alias user
  const alias = useCallback(async (userId: string, previousId?: string) => {
    try {
      await eventQueue.queueEvent({
        type: 'alias',
        userId,
        previousId,
        timestamp: Date.now(),
      }, {
        sessionId: getSessionId(),
        userId,
        userAgent: navigator.userAgent,
        ip: await getClientIP(),
        referrer: document.referrer,
        custom: {},
      });
    } catch (error) {
      console.error('Failed to alias user', error);
    }
  }, [eventQueue]);

  // Consent event
  const consentEvent = useCallback(async (newConsent: AnalyticsConsent) => {
    try {
      await eventQueue.queueEvent({
        type: 'consent',
        consent: newConsent,
        timestamp: Date.now(),
      }, {
        sessionId: getSessionId(),
        userId: getUserId(),
        userAgent: navigator.userAgent,
        ip: await getClientIP(),
        referrer: document.referrer,
        custom: {},
      });
    } catch (error) {
      console.error('Failed to track consent event', error);
    }
  }, [eventQueue]);

  const contextValue: AnalyticsContextType = {
    eventQueue,
    consent,
    scripts: analyticsScripts.scripts,
    loading: analyticsScripts.loading,
    error: analyticsScripts.error,
    track,
    page,
    identify,
    group,
    alias,
    consent: consentEvent,
  };

  return (
    <AnalyticsContext.Provider value={contextValue}>
      {children}
    </AnalyticsContext.Provider>
  );
}

export function useAnalytics(): AnalyticsContextType {
  const context = useContext(AnalyticsContext);
  if (!context) {
    throw new Error('useAnalytics must be used within an AnalyticsProvider');
  }
  return context;
}

// Helper functions
function getSessionId(): string {
  let sessionId = sessionStorage.getItem('c15t-session-id');
  if (!sessionId) {
    sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    sessionStorage.setItem('c15t-session-id', sessionId);
  }
  return sessionId;
}

function getUserId(): string | undefined {
  return localStorage.getItem('c15t-user-id') || undefined;
}

async function getClientIP(): Promise<string> {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    return data.ip;
  } catch (error) {
    return 'unknown';
  }
}
```

## 🧪 Testing Requirements
- Unit tests for updated components
- Unit tests for consent integration
- Unit tests for script management integration
- Unit tests for event queue integration
- Integration tests with new analytics system
- Backward compatibility tests
- Performance tests for updated components

## 🔍 Definition of Done
- [ ] ConsentManagerProvider updated to use new consent sync
- [ ] useAnalyticsScripts updated to use new script management
- [ ] Event queue integrated with frontend components
- [ ] Consent banner updated to work with new system
- [ ] Error handling integration implemented
- [ ] Backward compatibility maintained
- [ ] Unit tests for updated components
- [ ] Integration tests with new analytics system
- [ ] Code review completed

## 📚 Related Documentation
- [Analytics Frontend Integration](../docs/analytics-frontend-integration.md)
- [Analytics Architecture Diagram](../docs/analytics-architecture-diagram.md)

## 🔗 Dependencies
- [5.6: Consent State Synchronization](./27-consent-state-sync.md) ✅

## 🚀 Next Ticket
[5.8: Implement Migration Tooling Updates](./29-migration-tooling-updates.md)
