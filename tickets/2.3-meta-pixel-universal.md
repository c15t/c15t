# Ticket 2.3: Meta Pixel Universal Destination

## üìã Ticket Details
**Phase**: 2 - Universal Destinations  
**Story Points**: 5  
**Priority**: High  
**Assignee**: TBD  
**Status**: Ready

## üîó Dependencies
**Depends on**: Ticket 2.1 (Universal Destination Interface), Ticket 2.2 (Scripts Endpoint)  
**Blocking**: None  

## üéØ Description
Implement Meta Pixel with both server-side Conversions API calls and client-side pixel script generation. This universal destination enables Facebook/Meta advertising tracking with full GDPR compliance.

## üß† Context & Background
Meta Pixel is essential for Facebook/Meta advertising campaigns. This universal destination must:
- **Server-side**: Send events to Meta Conversions API for accurate attribution
- **Client-side**: Generate pixel scripts for browser-based tracking
- **GDPR compliance**: Only track when marketing consent is granted
- **Event mapping**: Convert analytics events to Meta pixel events
- **Error handling**: Gracefully handle API failures and rate limits

The destination integrates with:
- Meta Conversions API for server-side events
- Meta Pixel for client-side tracking
- Consent management for GDPR compliance
- Event processor for data transformation

## ‚úÖ Acceptance Criteria
- [ ] Create `MetaPixelDestination` class
- [ ] Implement server-side Conversions API calls
- [ ] Implement client-side pixel script generation
- [ ] Add Zod validation for settings
- [ ] Add connection testing
- [ ] Handle consent requirements (marketing)
- [ ] Unit tests for both server and client
- [ ] Integration tests with Meta APIs

## üìÅ Files to Create
- `packages/destinations/src/meta-pixel.ts`
- `packages/destinations/src/meta-pixel.test.ts`

## üîß Implementation Details

### Settings Schema
```typescript
import { z } from 'zod';

export const MetaPixelSettingsSchema = z.object({
  pixelId: z.string().min(1, 'Pixel ID is required'),
  accessToken: z.string().min(1, 'Access token is required'),
  testEventCode: z.string().optional(),
  apiVersion: z.string().default('v18.0'),
  enableServerSide: z.boolean().default(true),
  enableClientSide: z.boolean().default(true),
  customData: z.record(z.unknown()).optional(),
});

export type MetaPixelSettings = z.infer<typeof MetaPixelSettingsSchema>;
```

### Meta Pixel Destination Implementation
```typescript
import { UniversalDestinationPlugin } from '../types';
import { MetaPixelSettings, MetaPixelSettingsSchema } from './meta-pixel-settings';
import { AnalyticsEvent, EventContext, Script } from '../types';

export class MetaPixelDestination implements UniversalDestinationPlugin<MetaPixelSettings> {
  readonly type = 'meta-pixel';
  readonly version = '1.0.0';
  readonly gdprCompliant = true;
  readonly settingsSchema = MetaPixelSettingsSchema;
  readonly requiredConsent: ReadonlyArray<ConsentPurpose> = ['marketing'];
  readonly hasClientScript = true;

  private settings: MetaPixelSettings | null = null;
  private logger: Logger;

  constructor(logger: Logger) {
    this.logger = logger;
  }

  async initialize(settings: MetaPixelSettings): Promise<void> {
    this.settings = MetaPixelSettingsSchema.parse(settings);
    this.logger.info('Meta Pixel destination initialized', { 
      pixelId: this.settings.pixelId,
      enableServerSide: this.settings.enableServerSide,
      enableClientSide: this.settings.enableClientSide,
    });
  }

  async testConnection(): Promise<boolean> {
    if (!this.settings) {
      throw new Error('Meta Pixel destination not initialized');
    }

    try {
      // Test Conversions API connection
      const testEvent = {
        data: [{
          event_name: 'PageView',
          event_time: Math.floor(Date.now() / 1000),
          user_data: {
            client_ip_address: '127.0.0.1',
            client_user_agent: 'test-agent',
          },
          custom_data: {
            test: true,
          },
        }],
        test_event_code: this.settings.testEventCode,
      };

      const response = await fetch(
        `https://graph.facebook.com/${this.settings.apiVersion}/${this.settings.pixelId}/events`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.settings.accessToken}`,
          },
          body: JSON.stringify(testEvent),
        }
      );

      return response.ok;
    } catch (error) {
      this.logger.error('Meta Pixel connection test failed', { error: error.message });
      return false;
    }
  }

  async track(event: TrackEvent, context: EventContext): Promise<void> {
    if (!this.settings?.enableServerSide) return;
    if (!context.consent.marketing) return;

    try {
      const pixelEvent = this.mapTrackEvent(event, context);
      await this.sendToConversionsAPI(pixelEvent);
    } catch (error) {
      this.logger.error('Failed to send track event to Meta Pixel', {
        error: error.message,
        event: event.event,
      });
    }
  }

  async page(event: PageEvent, context: EventContext): Promise<void> {
    if (!this.settings?.enableServerSide) return;
    if (!context.consent.marketing) return;

    try {
      const pixelEvent = this.mapPageEvent(event, context);
      await this.sendToConversionsAPI(pixelEvent);
    } catch (error) {
      this.logger.error('Failed to send page event to Meta Pixel', {
        error: error.message,
        page: event.name,
      });
    }
  }

  async identify(event: IdentifyEvent, context: EventContext): Promise<void> {
    // Meta Pixel doesn't have a direct identify event
    // Store user data for future events
    this.logger.debug('Meta Pixel identify event received', { userId: event.userId });
  }

  generateScript(settings: MetaPixelSettings, consent: AnalyticsConsent): Script | null {
    if (!settings.enableClientSide) return null;
    if (!consent.marketing) return null;

    return {
      type: 'inline',
      content: `
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '${settings.pixelId}');
        fbq('track', 'PageView');
        ${settings.testEventCode ? `fbq('track', 'PageView', {}, {test_event_code: '${settings.testEventCode}'});` : ''}
      `,
      requiredConsent: ['marketing'],
      name: 'Meta Pixel',
      description: 'Facebook Meta Pixel tracking script',
    };
  }

  getScriptDependencies(): string[] {
    return [];
  }

  // Private methods
  private async sendToConversionsAPI(event: any): Promise<void> {
    if (!this.settings) return;

    const payload = {
      data: [event],
      test_event_code: this.settings.testEventCode,
    };

    const response = await fetch(
      `https://graph.facebook.com/${this.settings.apiVersion}/${this.settings.pixelId}/events`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.settings.accessToken}`,
        },
        body: JSON.stringify(payload),
      }
    );

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`Meta Conversions API error: ${response.status} ${error}`);
    }

    const result = await response.json();
    this.logger.debug('Meta Pixel event sent successfully', { 
      eventId: result.events_received,
    });
  }

  private mapTrackEvent(event: TrackEvent, context: EventContext): any {
    return {
      event_name: this.mapEventName(event.event),
      event_time: Math.floor(event.timestamp.getTime() / 1000),
      user_data: this.buildUserData(context),
      custom_data: {
        ...event.properties,
        ...this.settings?.customData,
      },
      event_source_url: context.custom?.url || '',
      action_source: 'website',
    };
  }

  private mapPageEvent(event: PageEvent, context: EventContext): any {
    return {
      event_name: 'PageView',
      event_time: Math.floor(event.timestamp.getTime() / 1000),
      user_data: this.buildUserData(context),
      custom_data: {
        page_name: event.name,
        page_url: event.url,
        ...this.settings?.customData,
      },
      event_source_url: event.url,
      action_source: 'website',
    };
  }

  private mapEventName(eventName: string): string {
    // Map common analytics events to Meta Pixel events
    const eventMap: Record<string, string> = {
      'Product Viewed': 'ViewContent',
      'Product Added': 'AddToCart',
      'Checkout Started': 'InitiateCheckout',
      'Purchase': 'Purchase',
      'Sign Up': 'CompleteRegistration',
      'Login': 'Login',
    };

    return eventMap[eventName] || 'CustomEvent';
  }

  private buildUserData(context: EventContext): any {
    const userData: any = {};

    if (context.userId) {
      userData.external_id = context.userId;
    }

    if (context.userAgent) {
      userData.client_user_agent = context.userAgent;
    }

    if (context.ip) {
      userData.client_ip_address = context.ip;
    }

    return userData;
  }
}
```

### Event Mapping Examples
```typescript
// Common event mappings
const EVENT_MAPPINGS = {
  // E-commerce events
  'Product Viewed': 'ViewContent',
  'Product Added to Cart': 'AddToCart',
  'Checkout Started': 'InitiateCheckout',
  'Purchase': 'Purchase',
  
  // User lifecycle events
  'Sign Up': 'CompleteRegistration',
  'Login': 'Login',
  'Lead': 'Lead',
  
  // Custom events
  'Newsletter Signup': 'CompleteRegistration',
  'Video Play': 'ViewContent',
  'Download': 'Lead',
};

// Custom data mapping
function mapCustomData(properties: Record<string, unknown>): Record<string, unknown> {
  const customData: Record<string, unknown> = {};
  
  // Map common properties
  if (properties.value) {
    customData.value = properties.value;
    customData.currency = properties.currency || 'USD';
  }
  
  if (properties.category) {
    customData.content_category = properties.category;
  }
  
  if (properties.product_id) {
    customData.content_ids = [properties.product_id];
  }
  
  return customData;
}
```

### Error Handling
```typescript
// Meta Pixel specific error types
export class MetaPixelError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode?: number
  ) {
    super(message);
    this.name = 'MetaPixelError';
  }
}

export class ConversionsAPIError extends MetaPixelError {
  constructor(message: string, statusCode: number) {
    super(message, 'CONVERSIONS_API_ERROR', statusCode);
  }
}

export class PixelScriptError extends MetaPixelError {
  constructor(message: string) {
    super(message, 'PIXEL_SCRIPT_ERROR');
  }
}

// Error handling in destination
private async handleAPIError(error: any, event: any): Promise<void> {
  if (error.status === 429) {
    // Rate limit - implement exponential backoff
    this.logger.warn('Meta Pixel rate limit exceeded', { event });
    throw new ConversionsAPIError('Rate limit exceeded', 429);
  }
  
  if (error.status >= 400 && error.status < 500) {
    // Client error - don't retry
    this.logger.error('Meta Pixel client error', { 
      status: error.status, 
      event,
      error: error.message 
    });
    throw new ConversionsAPIError('Client error', error.status);
  }
  
  // Server error - retryable
  this.logger.error('Meta Pixel server error', { 
    status: error.status, 
    event,
    error: error.message 
  });
  throw new ConversionsAPIError('Server error', error.status);
}
```

## üß™ Testing Requirements
- Unit tests for Meta Pixel destination
- Integration tests with Meta Conversions API
- Script generation tests
- Consent filtering tests
- Error handling tests
- Event mapping tests
- Connection testing tests

## üîç Definition of Done
- [ ] Meta Pixel destination sends events to Conversions API
- [ ] Client-side pixel script generated
- [ ] Settings validated with Zod schema
- [ ] Connection testing implemented
- [ ] Marketing consent requirement handled
- [ ] Unit tests for both server and client
- [ ] Integration tests with Meta APIs
- [ ] Code review completed

## üìö Related Documentation
- [Universal Destinations](../docs/analytics-universal-destinations.md)
- [Analytics Destination Packages Strategy](../docs/analytics-destination-packages-strategy.md)

## üîó Dependencies
- [2.1: Universal Destination Interface](./07-universal-destination-interface.md) ‚úÖ
- [2.2: Scripts Endpoint](./08-scripts-endpoint.md) ‚úÖ

## üöÄ Next Ticket
[2.4: Google Analytics Universal Destination](./10-google-analytics-universal.md)
