# Ticket 5.4: Database Loading

## üìã Ticket Details
**Phase**: 5 - Consent.io Control Plane  
**Story Points**: 3  
**Priority**: High  
**Assignee**: TBD  
**Status**: Ready

## üîó Dependencies
**Depends on**: Ticket 5.1 (Database Schema)  
**Blocking**: Ticket 5.6 (Scripts Endpoint Database)  

## üéØ Description
Enable loading destinations from database for consent.io deployed instances. This allows deployed instances to load their destination configurations from the control plane database, while self-hosted users continue using direct code configuration.

## üß† Context & Background
This ticket enables the **consent.io control plane** deployed instances to load destinations from the database where:

- **Deployed instances** load destinations from database instead of code
- **Database loading** fetches organization-specific configurations
- **Environment filtering** loads correct configs for dev/staging/production
- **Self-hosted users** continue using `c15tInstance` with direct configuration
- **Two deployment models** coexist:
  - **Consent.io SaaS**: Database ‚Üí Deployed Instance
  - **Self-hosted**: Code ‚Üí c15tInstance

The database loading must:
- Query destinations by organization and environment
- Decrypt sensitive settings from database
- Handle missing or invalid configurations
- Support fallback to direct configuration
- Cache configurations for performance

## ‚úÖ Acceptance Criteria
- [ ] Add `loadFromDatabase` option to C15TOptions
- [ ] Implement database query for destinations
- [ ] Add organization filtering
- [ ] Add environment filtering
- [ ] Add error handling for failed loads
- [ ] Add logging for loaded destinations
- [ ] Unit tests for database loading

## üìÅ Files to Modify
- `packages/backend/src/v2/init.ts`
- `packages/backend/src/v2/analytics/destination-manager.ts`

## üîß Implementation Details

### Enhanced C15TOptions
```typescript
// Updated C15TOptions interface
export interface C15TOptions {
  analytics?: {
    enabled?: boolean;
    destinations?: DestinationConfig[];
    
    // Database loading options (for consent.io deployed instances)
    loadFromDatabase?: boolean;
    organizationId?: string;
    environment?: Environment;
    
    // Database connection options
    databaseUrl?: string;
    databaseEncryptionKey?: string;
    
    // Fallback options
    fallbackToDirectConfig?: boolean;
    cacheConfigurations?: boolean;
    cacheTtl?: number; // in milliseconds
  };
}
```

### Database Loading Implementation
```typescript
import { DestinationRepository } from '../db/repositories/destination.repository';
import { SettingsEncryption } from '../utils/settings-encryption';
import { Logger } from '../logger';
import { DestinationConfig, Environment } from '../analytics/types';

interface DatabaseLoadingOptions {
  organizationId: string;
  environment: Environment;
  databaseUrl: string;
  databaseEncryptionKey: string;
  fallbackToDirectConfig: boolean;
  cacheConfigurations: boolean;
  cacheTtl: number;
}

class DatabaseDestinationLoader {
  private cache = new Map<string, { configs: DestinationConfig[]; timestamp: number }>();
  
  constructor(
    private destinationRepository: DestinationRepository,
    private settingsEncryption: SettingsEncryption,
    private logger: Logger
  ) {}

  async loadDestinations(options: DatabaseLoadingOptions): Promise<DestinationConfig[]> {
    const cacheKey = `${options.organizationId}-${options.environment}`;
    
    // Check cache first
    if (options.cacheConfigurations) {
      const cached = this.cache.get(cacheKey);
      if (cached && Date.now() - cached.timestamp < options.cacheTtl) {
        this.logger.debug('Loading destinations from cache', {
          organizationId: options.organizationId,
          environment: options.environment,
          count: cached.configs.length,
        });
        return cached.configs;
      }
    }

    try {
      this.logger.info('Loading destinations from database', {
        organizationId: options.organizationId,
        environment: options.environment,
      });

      // Query destinations from database
      const destinations = await this.destinationRepository.findByOrganization(
        options.organizationId,
        options.environment
      );

      // Filter enabled destinations
      const enabledDestinations = destinations.filter(dest => dest.enabled && !dest.deletedAt);

      // Convert to DestinationConfig format
      const configs = await Promise.all(
        enabledDestinations.map(async (dest) => {
          try {
            // Decrypt settings
            const settings = dest.settingsEncrypted 
              ? this.settingsEncryption.decrypt(dest.settings as any)
              : dest.settings;

            return {
              type: dest.type,
              enabled: dest.enabled,
              settings,
              requiredConsent: dest.requiredConsent,
            };
          } catch (error) {
            this.logger.error('Failed to decrypt destination settings', {
              destinationId: dest.id,
              destinationType: dest.type,
              error: error.message,
            });
            return null;
          }
        })
      );

      // Filter out failed decryptions
      const validConfigs = configs.filter((config): config is DestinationConfig => config !== null);

      // Cache the results
      if (options.cacheConfigurations) {
        this.cache.set(cacheKey, {
          configs: validConfigs,
          timestamp: Date.now(),
        });
      }

      this.logger.info('Successfully loaded destinations from database', {
        organizationId: options.organizationId,
        environment: options.environment,
        totalDestinations: destinations.length,
        enabledDestinations: enabledDestinations.length,
        validConfigs: validConfigs.length,
      });

      return validConfigs;
    } catch (error) {
      this.logger.error('Failed to load destinations from database', {
        error: error.message,
        organizationId: options.organizationId,
        environment: options.environment,
      });

      if (options.fallbackToDirectConfig) {
        this.logger.warn('Falling back to direct configuration due to database error');
        return [];
      }

      throw new Error(`Failed to load destinations from database: ${error.message}`);
    }
  }

  // Clear cache for organization/environment
  clearCache(organizationId: string, environment: Environment): void {
    const cacheKey = `${organizationId}-${environment}`;
    this.cache.delete(cacheKey);
    this.logger.debug('Cleared destination cache', { organizationId, environment });
  }

  // Clear all cache
  clearAllCache(): void {
    this.cache.clear();
    this.logger.debug('Cleared all destination cache');
  }
}
```

### Enhanced c15tInstance Factory
```typescript
// Updated c15tInstance factory with database loading support
export async function c15tInstance(options: C15TOptions = {}): Promise<C15TContext> {
  const logger = new Logger({ component: 'c15t' });
  
  try {
    logger.info('Initializing c15t analytics instance', { options });
    
    // Validate options
    const validatedOptions = validateOptions(options);
    
    // Initialize core components
    const eventProcessor = new EventProcessor(logger);
    const destinationManager = new DestinationManager(destinationRegistry, logger);
    
    // Load destinations based on configuration
    if (validatedOptions.analytics?.enabled !== false) {
      let destinations: DestinationConfig[] = [];
      
      // Check if we should load from database (consent.io deployed instances)
      if (validatedOptions.analytics?.loadFromDatabase) {
        const dbOptions = validatedOptions.analytics;
        
        if (!dbOptions.organizationId) {
          throw new Error('organizationId is required when loadFromDatabase is true');
        }
        
        if (!dbOptions.databaseUrl) {
          throw new Error('databaseUrl is required when loadFromDatabase is true');
        }
        
        // Initialize database components
        const destinationRepository = new DestinationRepository(dbOptions.databaseUrl);
        const settingsEncryption = new SettingsEncryption(dbOptions.databaseEncryptionKey!);
        const dbLoader = new DatabaseDestinationLoader(destinationRepository, settingsEncryption, logger);
        
        // Load destinations from database
        destinations = await dbLoader.loadDestinations({
          organizationId: dbOptions.organizationId,
          environment: dbOptions.environment || 'production',
          databaseUrl: dbOptions.databaseUrl,
          databaseEncryptionKey: dbOptions.databaseEncryptionKey!,
          fallbackToDirectConfig: dbOptions.fallbackToDirectConfig || false,
          cacheConfigurations: dbOptions.cacheConfigurations || true,
          cacheTtl: dbOptions.cacheTtl || 5 * 60 * 1000, // 5 minutes
        });
        
        logger.info('Loaded destinations from database', {
          count: destinations.length,
          organizationId: dbOptions.organizationId,
          environment: dbOptions.environment,
        });
      } else {
        // Load destinations from direct configuration (self-hosted)
        destinations = validatedOptions.analytics?.destinations || [];
        
        logger.info('Loaded destinations from direct configuration', {
          count: destinations.length,
        });
      }
      
      // Load destinations into manager
      if (destinations.length > 0) {
        logger.info('Loading destinations into manager', { count: destinations.length });
        await destinationManager.loadDestinations(destinations);
      }
    }
    
    // Create context
    const context: C15TContext = {
      destinationManager,
      eventProcessor,
      logger,
      handlers: {
        processEvents: (req, res) => processEventsHandler(req, res, {
          eventProcessor,
          destinationManager,
          logger,
        }),
      },
      utils: {
        getDestinationStatus: (type: string) => destinationManager.getDestinationStatus(type),
        testDestination: (type: string) => destinationManager.testDestination(type),
        getLoadedDestinations: () => destinationManager.getLoadedDestinations(),
      },
    };
    
    logger.info('c15t analytics instance initialized successfully');
    return context;
    
  } catch (error) {
    logger.error('Failed to initialize c15t analytics instance', {
      error: error.message,
      stack: error.stack,
    });
    throw new Error(`Failed to initialize c15t: ${error.message}`);
  }
}
```

### Usage Examples
```typescript
// Consent.io deployed instance (loads from database)
const instance = await c15tInstance({
  analytics: {
    loadFromDatabase: true,
    organizationId: 'org-123',
    environment: 'production',
    databaseUrl: process.env.DATABASE_URL,
    databaseEncryptionKey: process.env.ENCRYPTION_KEY,
    fallbackToDirectConfig: true,
    cacheConfigurations: true,
    cacheTtl: 5 * 60 * 1000, // 5 minutes
  },
});

// Self-hosted instance (direct configuration)
const instance = await c15tInstance({
  analytics: {
    destinations: [
      posthog({ apiKey: 'phc_xxx' }),
      metaPixel({ pixelId: '123', accessToken: 'token' }),
    ],
  },
});
```

### Self-Hosted Integration Note
```typescript
// For self-hosted users, they continue using direct configuration:
// Database loading is ONLY for consent.io deployed instances

// Self-hosted example:
const instance = await c15tInstance({
  analytics: {
    destinations: [
      posthog({ apiKey: 'phc_their_key' }),
      metaPixel({ pixelId: '123', accessToken: 'their_token' }),
    ],
  },
});

// Consent.io deployed instances load from database via this feature
```

## üß™ Testing Requirements
- Unit tests for database loading
- Integration tests with database
- Organization filtering tests
- Environment filtering tests
- Error handling tests
- Cache tests
- Fallback tests
- Performance tests

## üîç Definition of Done
- [ ] loadFromDatabase option added to C15TOptions
- [ ] Database query for destinations implemented
- [ ] Organization filtering added
- [ ] Environment filtering added
- [ ] Error handling for failed loads
- [ ] Logging for loaded destinations
- [ ] Unit tests for database loading
- [ ] Code review completed

## üìö Related Documentation
- [Cloud Configuration](../docs/analytics-cloud-configuration.md)
- [Analytics Architecture Diagram](../docs/analytics-architecture-diagram.md)

## üîó Dependencies
- [3.1: Database Schema](./12-database-schema.md) ‚úÖ
- [3.2: Admin API Contracts](./13-admin-api-contracts.md) ‚úÖ
- [3.3: Admin API Handlers](./14-admin-api-handlers.md) ‚úÖ

## üöÄ Next Ticket
[3.5: Create Admin UI Components](./16-admin-ui-components.md)
