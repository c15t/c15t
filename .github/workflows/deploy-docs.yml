name: Docs Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'docs/**'
      - 'packages/**'
      - 'changelog/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        type: choice
        options:
          - production
          - staging
          - preview
      pr_number:
        description: 'PR number for preview deployment (required if environment is preview)'
        required: false
        type: string

jobs:
  # ============================================================================
  # PREVIEW DEPLOYMENTS (for PRs)
  # ============================================================================
  trigger-preview:
    name: ðŸ” Trigger Preview
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Trigger docs preview
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-preview
          client-payload: |
            {
              "pr_number": "${{ github.event.pull_request.number }}",
              "branch": "${{ github.head_ref }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.event.pull_request.head.sha }}",
              "action": "${{ github.event.action }}"
            }

      - name: ðŸ“ Summary
        run: |
          echo "### ðŸ”„ Docs Preview Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A preview deployment has been triggered. Watch for a comment on this PR with the preview URL." >> $GITHUB_STEP_SUMMARY

  notify-close:
    name: ðŸ§¹ Notify PR Closed
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Notify docs repo of PR close
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-preview
          client-payload: |
            {
              "pr_number": "${{ github.event.pull_request.number }}",
              "branch": "${{ github.head_ref }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.event.pull_request.head.sha }}",
              "action": "closed"
            }

  # ============================================================================
  # MANUAL PREVIEW DEPLOYMENT (workflow_dispatch with PR number)
  # ============================================================================
  trigger-manual-preview:
    name: ðŸ” Trigger Manual Preview
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'preview'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: ðŸ“‹ Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ github.event.inputs.pr_number }}';
            if (!prNumber) {
              core.setFailed('PR number is required for preview deployment');
              return;
            }
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('branch', pr.head.ref);
            core.setOutput('sha', pr.head.sha);
            core.setOutput('repo', pr.head.repo.full_name);
            core.setOutput('action', 'opened');

      - name: ðŸ“¤ Trigger docs preview
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-preview
          client-payload: |
            {
              "pr_number": "${{ steps.pr-info.outputs.pr_number }}",
              "branch": "${{ steps.pr-info.outputs.branch }}",
              "repo": "${{ steps.pr-info.outputs.repo }}",
              "sha": "${{ steps.pr-info.outputs.sha }}",
              "action": "${{ steps.pr-info.outputs.action }}"
            }

      - name: ðŸ“ Summary
        run: |
          echo "### ðŸ”„ Manual Docs Preview Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A preview deployment has been triggered for PR #${{ steps.pr-info.outputs.pr_number }}." >> $GITHUB_STEP_SUMMARY
          echo "Watch for a comment on the PR with the preview URL." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ steps.pr-info.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.pr-info.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.pr-info.outputs.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # PRODUCTION DEPLOYMENT (main â†’ c15t.com)
  # ============================================================================
  trigger-production:
    name: ðŸš€ Trigger Production
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Trigger production deploy
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-production
          client-payload: |
            {
              "branch": "${{ github.ref_name }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.sha }}"
            }

      - name: ðŸ“ Summary
        run: |
          echo "### ðŸš€ Production Deploy Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** https://c15t.com/docs" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGING DEPLOYMENT (staging â†’ canary.c15t.com)
  # ============================================================================
  trigger-staging:
    name: ðŸ§ª Trigger Staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Trigger staging deploy
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-staging
          client-payload: |
            {
              "branch": "${{ github.ref_name }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.sha }}"
            }

      - name: ðŸ“ Summary
        run: |
          echo "### ðŸ§ª Staging Deploy Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** https://canary.c15t.com/docs" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
