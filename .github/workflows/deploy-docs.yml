name: Docs Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'docs/**'
      - 'packages/**'
      - 'changelog/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging

jobs:
  # ============================================================================
  # PREVIEW DEPLOYMENTS (for PRs)
  # ============================================================================
  trigger-preview:
    name: ðŸ” Trigger Preview
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Trigger docs preview
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-preview
          client-payload: |
            {
              "pr_number": "${{ github.event.pull_request.number }}",
              "branch": "${{ github.head_ref }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.event.pull_request.head.sha }}",
              "action": "${{ github.event.action }}"
            }

      - name: ðŸ“ Summary
        run: |
          echo "### ðŸ”„ Docs Preview Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A preview deployment has been triggered. Watch for a comment on this PR with the preview URL." >> $GITHUB_STEP_SUMMARY

  notify-close:
    name: ðŸ§¹ Notify PR Closed
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Notify docs repo of PR close
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-preview
          client-payload: |
            {
              "pr_number": "${{ github.event.pull_request.number }}",
              "branch": "${{ github.head_ref }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.event.pull_request.head.sha }}",
              "action": "closed"
            }

  # ============================================================================
  # PRODUCTION DEPLOYMENT (main â†’ c15t.com)
  # ============================================================================
  trigger-production:
    name: ðŸš€ Trigger Production
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Trigger production deploy
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-production
          client-payload: |
            {
              "branch": "${{ github.ref_name }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.sha }}"
            }

      - name: ðŸ“ Summary
        run: |
          echo "### ðŸš€ Production Deploy Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** https://c15t.com/docs" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGING DEPLOYMENT (staging â†’ canary.c15t.com)
  # ============================================================================
  trigger-staging:
    name: ðŸ§ª Trigger Staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¤ Trigger staging deploy
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          repository: ${{ secrets.DOCS_REPO }}
          event-type: docs-staging
          client-payload: |
            {
              "branch": "${{ github.ref_name }}",
              "repo": "${{ github.repository }}",
              "sha": "${{ github.sha }}"
            }

      - name: ðŸ“ Summary
        run: |
          echo "### ðŸ§ª Staging Deploy Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** https://canary.c15t.com/docs" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
