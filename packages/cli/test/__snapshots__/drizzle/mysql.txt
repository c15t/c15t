import { mysqlTable, varchar, text, int, timestamp, boolean } from "drizzle-orm/mysql-core";

export const user = mysqlTable("user", {
  id: varchar("id", { length: 36 }).primaryKey(),
  isIdentified: boolean('is_identified').notNull(),
  externalId: text('external_id'),
  identityProvider: text('identity_provider'),
  lastIpAddress: text('last_ip_address'),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull()
});

export const purpose = mysqlTable("purpose", {
  id: varchar("id", { length: 36 }).primaryKey(),
  code: text('code').notNull(),
  name: text('name').notNull(),
  description: text('description').notNull(),
  isEssential: boolean('is_essential').notNull(),
  dataCategory: text('data_category'),
  legalBasis: text('legal_basis'),
  isActive: boolean('is_active').notNull(),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at').notNull()
});

export const consentPolicy = mysqlTable("consent_policy", {
  id: varchar("id", { length: 36 }).primaryKey(),
  version: text('version').notNull(),
  name: text('name').notNull(),
  effectiveDate: timestamp('effective_date').notNull(),
  expirationDate: timestamp('expiration_date'),
  content: text('content').notNull(),
  contentHash: text('content_hash').notNull(),
  isActive: boolean('is_active').notNull(),
  createdAt: timestamp('created_at').notNull()
});

export const domain = mysqlTable("domain", {
  id: varchar("id", { length: 36 }).primaryKey(),
  name: varchar('name', { length: 255 }).notNull().unique(),
  description: text('description'),
  allowedOrigins: text('allowed_origins'),
  isVerified: boolean('is_verified').notNull(),
  isActive: boolean('is_active').notNull(),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at')
});

export const consent = mysqlTable("consent", {
  id: varchar("id", { length: 36 }).primaryKey(),
  userId: varchar('user_id', { length: 36 }).notNull().references(()=> user.id, { onDelete: 'cascade' }),
  domainId: varchar('domain_id', { length: 36 }).notNull().references(()=> domain.id, { onDelete: 'cascade' }),
  purposeIds: text('purpose_ids').notNull(),
  policyId: varchar('policy_id', { length: 36 }).references(()=> consentPolicy.id, { onDelete: 'cascade' }),
  status: text('status').notNull(),
  withdrawalReason: text('withdrawal_reason'),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  metadata: text('metadata'),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at'),
  expiresAt: timestamp('expires_at')
});

export const purposeJunction = mysqlTable("purpose_junction", {
  id: varchar("id", { length: 36 }).primaryKey(),
  consentId: varchar('consent_id', { length: 36 }).notNull().references(()=> consent.id, { onDelete: 'cascade' }),
  purposeId: varchar('purpose_id', { length: 36 }).notNull().references(()=> purpose.id, { onDelete: 'cascade' }),
  status: text('status').notNull(),
  metadata: text('metadata'),
  createdAt: timestamp('created_at').notNull(),
  updatedAt: timestamp('updated_at')
});

export const record = mysqlTable("record", {
  id: varchar("id", { length: 36 }).primaryKey(),
  userId: varchar('user_id', { length: 36 }).notNull().references(()=> user.id, { onDelete: 'cascade' }),
  consentId: varchar('consent_id', { length: 36 }).references(()=> consent.id, { onDelete: 'cascade' }),
  actionType: text('action_type').notNull(),
  details: text('details'),
  createdAt: timestamp('created_at').notNull()
});

export const consentGeoLocation = mysqlTable("consent_geo_location", {
  id: varchar("id", { length: 36 }).primaryKey(),
  consentId: varchar('consent_id', { length: 36 }).notNull().references(()=> consent.id, { onDelete: 'cascade' }),
  ip: text('ip').notNull(),
  country: text('country'),
  region: text('region'),
  city: text('city'),
  latitude: int('latitude'),
  longitude: int('longitude'),
  timezone: text('timezone'),
  createdAt: timestamp('created_at').notNull()
});

export const withdrawal = mysqlTable("withdrawal", {
  id: varchar("id", { length: 36 }).primaryKey(),
  consentId: varchar('consent_id', { length: 36 }).notNull().references(()=> consent.id, { onDelete: 'cascade' }),
  userId: varchar('user_id', { length: 36 }).notNull().references(()=> user.id, { onDelete: 'cascade' }),
  withdrawalReason: text('withdrawal_reason'),
  withdrawalMethod: text('withdrawal_method').notNull(),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  metadata: text('metadata'),
  createdAt: timestamp('created_at').notNull()
});

export const auditLog = mysqlTable("audit_log", {
  id: varchar("id", { length: 36 }).primaryKey(),
  entityType: text('entity_type').notNull(),
  entityId: text('entity_id').notNull(),
  actionType: text('action_type').notNull(),
  userId: varchar('user_id', { length: 36 }).references(()=> user.id, { onDelete: 'cascade' }),
  ipAddress: text('ip_address'),
  userAgent: text('user_agent'),
  changes: text('changes'),
  metadata: text('metadata'),
  createdAt: timestamp('created_at').notNull()
});

export const geoLocation = mysqlTable("geo_location", {
  id: varchar("id", { length: 36 }).primaryKey(),
  countryCode: text('country_code').notNull(),
  countryName: text('country_name').notNull(),
  regionCode: text('region_code'),
  regionName: text('region_name'),
  regulatoryZones: text('regulatory_zones'),
  createdAt: timestamp('created_at').notNull()
});